---
title: OrderMetrologistCalcController (App\Http\Controllers\OrderMetrologistCalc)
markmap: colorFreezeLevel: 2
---

## OrderMetrologistCalcController

### getOrdersData(Запрос $request): JsonResponse

- **Попытка**
  - Получить параметры поиска (search), страницы (page), лимита (limit) и смещения (offset) из запроса
  - Загрузить SQL запросы из файлов
  - **Если** указан параметр поиска (search):
    - Добавить условие поиска в SQL запросы
    - Добавить параметр поиска в параметры запроса к базе данных
  - Выполнить основной SQL запрос с параметрами
  - **Если** указан параметр поиска (search):
    - Выполнить SQL запрос для подсчета общего количества результатов с параметром поиска
  - **Иначе:**
    - Выполнить SQL запрос для подсчета общего количества результатов без параметра поиска
  - Получить общее количество результатов из результата запроса подсчета
  - Вернуть JSON ответ с:
    - текущей страницей (currentPage)
    - количеством элементов на странице (itemsPerPage)
    - общим количеством результатов (totalCount)
    - заказами (orders)
- **Перехват** Исключения $e
  - Вернуть JSON ответ с сообщением об ошибке и кодом состояния 500

## Запрос

- query('search') - получить значение параметра поиска из запроса
- query('page') - получить номер страницы из запроса
- query('limit') - получить лимит количества элементов на странице из запроса

## База данных (DB)

- select($sql, $parameters) - выполнить SQL запрос с заданными параметрами
- selectOne($countSql, $countParameters) - выполнить SQL запрос и получить один результат

## Ответ

- json([
  'currentPage' => $page,
  'itemsPerPage' => $limit,
  'totalCount' => $totalCount,
  'orders' => $orders
  ]) - сформировать JSON ответ с данными о заказах

- json(['message' => $e->getMessage()], 500) - сформировать JSON ответ с сообщением об ошибке и кодом состояния 500
